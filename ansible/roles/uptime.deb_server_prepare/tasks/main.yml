- name: Upgrade packages
  apt:
    upgrade: "yes"
    update_cache: yes
  register: first_ubuntu_update
  until: "first_ubuntu_update is not failed"
  retries: 10
  delay: 10

- name: Fix pip mess idk
  shell: >
    mv /usr/local/lib/python3.8/dist-packages/cryptography /usr/local/lib/python3.8/dist-packages/cryptography.bkp && pip3 install pip --upgrade && pip3 install docker --upgrade
  failed_when: false
  # args:
  #   warn: false
  # when: apt_upgrade is failed

- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: Ensure we have python3 tools installed
  apt:
    name:
      - python3-pip
      - python3-setuptools

- name: Ensure we have sudo installed
  apt:
    name: sudo

- name: Make sure we have a 'sudo' group
  group:
    name: sudo
    state: present

- name: Allow 'sudo' group to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: "^%sudo"
    line: "%sudo ALL=(ALL) NOPASSWD: ALL"
    validate: visudo -cf %s
  when: passwordless_sudo

- name: Ensure standard sudoers configuration with passwordless sudo
  template:
    src: sudoers.j2
    dest: /etc/sudoers

- name: Add {{ base_unix_user }} user and add it to sudo group
  user:
    name: "{{ base_unix_user }}"
    password: "{{ base_user_password | password_hash('sha512', 'myseijJIjretsalt') }}"
    shell: /bin/bash
    groups: ["sudo"]
    append: yes

- name: Make sure {{ base_unix_user }} user owns its home
  file:
    path: /home/{{ base_unix_user }}
    owner: "{{ base_unix_user }}"
    group: "{{ base_unix_user }}"
#     recurse: yes

- name: Allow user '{{ base_unix_user }}' ssh connexion
  lineinfile:
    dest: /etc/ssh/sshd_config
    state: present
    regexp: "^AllowUsers"
    line: "AllowUsers root {{ base_unix_user }}"
  notify: reload sshd

- name: Configure (yes/no) ssh connexion using password
  lineinfile:
    dest: /etc/ssh/sshd_config
    state: present
    regexp: "^PasswordAuthentication"
    line: "PasswordAuthentication {{ allow_passwd_ssh_connection }}"
  notify: reload sshd

- name: Ensure user .ssh folder present
  file:
    state: directory
    path: /home/{{ base_unix_user }}/.ssh
    owner: "{{ base_unix_user }}"
    group: "{{ base_unix_user }}"

- name: Configure {{ base_unix_user }} authorized_keys if a public key was defined
  copy:
    src: "{{ ssh_public_key }}"
    dest: /home/{{ base_unix_user }}/.ssh/authorized_keys
    owner: "{{ base_unix_user }}"
    group: "{{ base_unix_user }}"
  when: ssh_public_key|bool
